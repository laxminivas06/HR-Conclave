<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Templates - SmartHR Campus</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .template-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        .template-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .variable-badge {
            background-color: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-right: 5px;
            margin-bottom: 5px;
            display: inline-block;
        }
        .preview-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin/dashboard">
                <i class="bi bi-envelope-fill me-2"></i>SmartHR Email Templates
            </a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/email">
                            <i class="bi bi-arrow-left me-1"></i>Back to Email
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/dashboard">
                            <i class="bi bi-speedometer2 me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/logout">
                            <i class="bi bi-box-arrow-right me-1"></i>Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-file-earmark-text me-2"></i>Email Templates
                        </h5>
                        <button class="btn btn-primary" onclick="createNewTemplate()">
                            <i class="bi bi-plus-circle me-1"></i>Create New Template
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row" id="templatesContainer">
                            {% for template_id, template in templates.items() %}
                            <div class="col-md-6 col-lg-4">
                                <div class="template-card">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="bi bi-envelope me-2"></i>{{ template.name }}
                                        </h6>
                                        <p class="card-text text-muted small mb-2">
                                            <strong>Subject:</strong> {{ template.subject }}
                                        </p>
                                        
                                        <div class="mb-3">
                                            <small class="text-muted">Variables:</small><br>
                                            {% for var in template.variables %}
                                            <span class="variable-badge">{{ '{' + var + '}' }}</span>
                                            {% endfor %}
                                        </div>
                                        
                                        <div class="preview-box small">
                                            {{ template.body[:200] }}{% if template.body|length > 200 %}...{% endif %}
                                        </div>
                                        
                                        <div class="d-flex justify-content-between mt-3">
                                            <button class="btn btn-sm btn-outline-primary" 
                                                    onclick="editTemplate('{{ template_id }}')">
                                                <i class="bi bi-pencil me-1"></i>Edit
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" 
                                                    onclick="previewTemplate('{{ template_id }}')">
                                                <i class="bi bi-eye me-1"></i>Preview
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" 
                                                    onclick="deleteTemplate('{{ template_id }}')"
                                                    {% if template_id in ['student_invitation', 'hr_invitation', 'question_submission_confirmation', 'thank_you_email'] %}disabled{% endif %}>
                                                <i class="bi bi-trash me-1"></i>Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Editor Modal -->
    <div class="modal fade" id="templateEditorModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Edit Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="templateForm">
                        <input type="hidden" id="templateId">
                        
                        <div class="mb-3">
                            <label for="templateName" class="form-label">Template Name</label>
                            <input type="text" class="form-control" id="templateName" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="templateSubject" class="form-label">Email Subject</label>
                            <input type="text" class="form-control" id="templateSubject" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="templateBody" class="form-label">Email Body</label>
                            <textarea class="form-control" id="templateBody" rows="10" required></textarea>
                            <div class="form-text">
                                Use variables like {name}, {email}, etc. They will be replaced with actual values.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Available Variables</label>
                            <div id="variablesList" class="d-flex flex-wrap gap-2">
                                <!-- Variables will be populated here -->
                            </div>
                            <div class="form-text">
                                Click on a variable to insert it at the cursor position.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="customVariables" class="form-label">Custom Variables (comma-separated)</label>
                            <input type="text" class="form-control" id="customVariables" 
                                   placeholder="name, email, event_date, etc.">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTemplate()">Save Template</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Template Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="previewContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Available system variables
        const systemVariables = {
            'General': ['name', 'email', 'roll_number', 'hr_id', 'password'],
            'Event': ['event_date', 'event_venue', 'event_title', 'panel_title', 'panel_time'],
            'URLs': ['registration_url', 'login_url', 'dashboard_url', 'feedback_url'],
            'Statistics': ['question_count', 'submission_time', 'total_participants', 'total_questions', 'total_interactions']
        };

        let templates = {{ templates|tojson }};

        function createNewTemplate() {
            document.getElementById('modalTitle').textContent = 'Create New Template';
            document.getElementById('templateId').value = '';
            document.getElementById('templateName').value = '';
            document.getElementById('templateSubject').value = '';
            document.getElementById('templateBody').value = '';
            document.getElementById('customVariables').value = '';
            
            // Populate variables
            populateVariables([]);
            
            const modal = new bootstrap.Modal(document.getElementById('templateEditorModal'));
            modal.show();
        }

        function editTemplate(templateId) {
            const template = templates[templateId];
            if (!template) return;
            
            document.getElementById('modalTitle').textContent = 'Edit Template: ' + template.name;
            document.getElementById('templateId').value = templateId;
            document.getElementById('templateName').value = template.name;
            document.getElementById('templateSubject').value = template.subject;
            document.getElementById('templateBody').value = template.body;
            document.getElementById('customVariables').value = template.variables ? template.variables.join(', ') : '';
            
            // Populate variables
            populateVariables(template.variables || []);
            
            const modal = new bootstrap.Modal(document.getElementById('templateEditorModal'));
            modal.show();
        }

        function populateVariables(existingVars) {
            const container = document.getElementById('variablesList');
            container.innerHTML = '';
            
            // Add existing variables
            existingVars.forEach(variable => {
                if (!Object.values(systemVariables).flat().includes(variable)) {
                    const badge = document.createElement('span');
                    badge.className = 'variable-badge';
                    badge.textContent = '{' + variable + '}';
                    badge.onclick = () => insertVariable(variable);
                    container.appendChild(badge);
                }
            });
            
            // Add system variables
            for (const [category, vars] of Object.entries(systemVariables)) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'w-100 mt-2';
                categoryDiv.innerHTML = `<small class="text-muted">${category}:</small>`;
                container.appendChild(categoryDiv);
                
                vars.forEach(variable => {
                    const badge = document.createElement('span');
                    badge.className = 'variable-badge';
                    badge.textContent = '{' + variable + '}';
                    badge.onclick = () => insertVariable(variable);
                    container.appendChild(badge);
                });
            }
        }

        function insertVariable(variable) {
            const textarea = document.getElementById('templateBody');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const variableText = '{' + variable + '}';
            
            textarea.value = textarea.value.substring(0, start) + 
                           variableText + 
                           textarea.value.substring(end);
            
            // Move cursor after inserted variable
            textarea.selectionStart = textarea.selectionEnd = start + variableText.length;
            textarea.focus();
        }

        async function saveTemplate() {
            const templateId = document.getElementById('templateId').value || 
                              'template_' + Date.now();
            const templateName = document.getElementById('templateName').value;
            const subject = document.getElementById('templateSubject').value;
            const body = document.getElementById('templateBody').value;
            const customVars = document.getElementById('customVariables').value
                .split(',')
                .map(v => v.trim())
                .filter(v => v);
            
            // Extract variables from body
            const bodyVars = [...new Set([...body.matchAll(/\{([^}]+)\}/g)].map(m => m[1]))];
            const allVariables = [...new Set([...customVars, ...bodyVars])];
            
            const template = {
                id: templateId,
                name: templateName,
                subject: subject,
                body: body,
                variables: allVariables
            };
            
            const response = await fetch('/api/email/templates', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: templateId,
                    template: template
                })
            });
            
            const result = await response.json();
            if (result.success) {
                alert('Template saved successfully!');
                window.location.reload();
            } else {
                alert('Error: ' + result.error);
            }
        }

        async function deleteTemplate(templateId) {
            if (!confirm('Are you sure you want to delete this template?')) return;
            
            // Note: Default templates cannot be deleted (handled by backend)
            const response = await fetch('/api/email/templates', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: templateId,
                    template: null  // Setting to null will delete
                })
            });
            
            const result = await response.json();
            if (result.success) {
                alert('Template deleted successfully!');
                window.location.reload();
            } else {
                alert('Error: ' + result.error);
            }
        }

        function previewTemplate(templateId) {
            const template = templates[templateId];
            if (!template) return;
            
            let preview = `
                <div class="card">
                    <div class="card-header">
                        <h6>${template.name}</h6>
                        <small class="text-muted">Subject: ${template.subject}</small>
                    </div>
                    <div class="card-body">
                        <pre style="white-space: pre-wrap; font-family: inherit;">${template.body}</pre>
                        <hr>
                        <div>
                            <small class="text-muted">Variables:</small>
                            <div class="mt-2">
            `;
            
            template.variables.forEach(variable => {
                preview += `<span class="variable-badge">{${variable}}</span> `;
            });
            
            preview += `</div></div></div></div>`;
            
            document.getElementById('previewContent').innerHTML = preview;
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            modal.show();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Make template cards clickable for edit
            document.querySelectorAll('.template-card').forEach(card => {
                card.style.cursor = 'pointer';
                card.addEventListener('click', function(e) {
                    if (!e.target.closest('button')) {
                        const templateId = this.querySelector('.btn').getAttribute('onclick')
                            .match(/'([^']+)'/)[1];
                        editTemplate(templateId);
                    }
                });
            });
        });
    </script>
</body>
</html>