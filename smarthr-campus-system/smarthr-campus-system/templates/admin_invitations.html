<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invitations Management - Admin Panel</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1a56db, #7e22ce);
        }
        
        .sidebar {
            min-height: calc(100vh - 64px);
        }
        
        .sidebar-link {
            transition: all 0.3s ease;
        }
        
        .sidebar-link:hover {
            background: rgba(255, 255, 255, 0.1);
            padding-left: 1.5rem;
        }
        
        .sidebar-link.active {
            background: rgba(255, 255, 255, 0.15);
            border-left: 4px solid white;
        }
        
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            background: white;
            color: #1a56db;
        }
        
        .checkbox-round {
            width: 1.3em;
            height: 1.3em;
            border-radius: 50%;
            vertical-align: middle;
            border: 2px solid #ddd;
            appearance: none;
            -webkit-appearance: none;
            outline: none;
            cursor: pointer;
        }
        
        .checkbox-round:checked {
            background-color: #1a56db;
            border-color: #1a56db;
        }
        
        /* File Upload Styling */
        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            background: #f9fafb;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .file-upload-area:hover {
            border-color: #1a56db;
            background: #f0f9ff;
        }
        
        .file-preview-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
        }
        
        .file-preview-item img {
            max-width: 50px;
            max-height: 50px;
            object-fit: cover;
            border-radius: 0.25rem;
        }
        
        .recipient-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            background: #e0f2fe;
            color: #0369a1;
            border-radius: 9999px;
            font-size: 0.875rem;
            margin: 0.125rem;
        }
        
        /* Status Colors */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-sent { background: #dbeafe; color: #1e40af; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-rejected { background: #fee2e2; color: #991b1b; }
        .status-registered { background: #dcfce7; color: #166534; }
        .status-approved { background: #d1fae5; color: #065f46; }
        
        /* Responsive Design */
        @media (min-width: 768px) {
            body {
                display: flex;
                flex-direction: column;
                min-height: 100vh;
            }

            nav.gradient-bg {
                position: sticky;
                top: 0;
                z-index: 1000;
            }

            .flex {
                display: flex;
                flex: 1;
                min-height: 0;
            }

            /* Sidebar */
            .w-64.bg-gray-800.text-white.sidebar {
                position: sticky;
                top: 64px;
                height: calc(100vh - 64px);
                overflow-y: auto;
            }

            /* Main content */
            .flex-1 {
                flex: 1;
                overflow-y: auto;
                height: calc(100vh - 64px);
            }
        }

        /* Mobile Sidebar */
        .mobile-sidebar-panel {
            position: fixed;
            right: 0;
            top: 0;
            height: 100vh;
            width: 280px;
            background: #1f2937;
            color: white;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 45;
            display: flex;
            flex-direction: column;
        }

        .mobile-sidebar-panel.active {
            transform: translateX(0);
        }

        .mobile-sidebar-panel > div:last-child {
            flex: 1;
            overflow-y: auto;
        }

        .mobile-sidebar-panel .close-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .mobile-sidebar-panel .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Mobile Recipient Selection */
        .mobile-recipient-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 1rem 1rem 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            z-index: 100;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        
        .mobile-recipient-panel.active {
            transform: translateY(0);
        }
        
        .recipient-option {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .recipient-option:hover {
            background: #f9fafb;
        }
        
        .recipient-option.active {
            background: #eff6ff;
        }
        
        .recipient-count {
            font-size: 0.75rem;
            color: #6b7280;
            margin-left: auto;
        }
        
        /* HR Selection Items */
        .hr-selection-item {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #e5e7eb;
            background: white;
        }

        .hr-selection-item:hover {
            background-color: #f9fafb;
            border-color: #d1d5db;
        }

        .hr-selection-item.selected {
            background-color: #e0f2fe;
            border-color: #1a56db;
        }

        .hr-selection-item .checkbox-round {
            margin-top: 4px;
            flex-shrink: 0;
        }

        .hr-selection-item-content {
            flex: 1;
            margin-left: 12px;
            min-width: 0;
        }

        .hr-selection-item-name {
            font-weight: 500;
            color: #111827;
            margin-bottom: 2px;
            word-break: break-word;
        }

        .hr-selection-item-details {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 4px;
            word-break: break-word;
        }

        .hr-selection-item-meta {
            font-size: 0.75rem;
            color: #9ca3af;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        
        /* Attachment Preview */
        .attachment-preview {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }
        
        .attachment-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e5e7eb;
            border-radius: 0.375rem;
            color: #6b7280;
        }
        
        .attachment-info {
            flex: 1;
            min-width: 0;
        }
        
        .attachment-name {
            font-weight: 500;
            color: #111827;
            word-break: break-all;
        }
        
        .attachment-size {
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .mobile-header {
                display: flex;
            }
            
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                height: 100vh;
                z-index: 1000;
                transition: left 0.3s ease;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .main-content {
                padding-left: 0;
                margin-top: 4rem;
            }
            
            .overflow-x-auto {
                overflow-x: auto;
            }
            
            /* Mobile menu button */
            .mobile-menu-button {
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 50;
                background: linear-gradient(135deg, #1a56db, #7e22ce);
                color: white;
                width: 56px;
                height: 56px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                border: none;
                font-size: 1.5rem;
            }
            
            /* Mobile sidebar overlay */
            .mobile-sidebar-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 40;
                display: none;
            }
            
            .mobile-sidebar-overlay.active {
                display: block;
            }
            
            /* Compact tables on mobile */
            .table th, .table td {
                padding: 0.5rem !important;
                font-size: 0.75rem;
            }
        }
        

        /* Notification styles */
.notification {
    animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes fadeOut {
    from {
        opacity: 1;
    }
    to {
        opacity: 0;
    }
}

        /* Desktop */
        @media (min-width: 769px) {
            .mobile-header {
                display: none;
            }
        }
        
        /* Loading Modal */
        .loading-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            text-align: center;
            min-width: 300px;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Email Template Selector */
        .email-template-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .email-template-card:hover {
            border-color: #1a56db;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .email-template-card.selected {
            border-color: #1a56db;
            background: #f0f9ff;
        }
        
        .template-preview {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.875rem;
            line-height: 1.5;
        }
    </style>
</head>

<body class="bg-gray-100">
    <!-- Mobile Header -->
    <div class="mobile-header gradient-bg text-white p-4 flex justify-between items-center fixed top-0 left-0 right-0 z-50 md:hidden">
        <div class="flex items-center space-x-3">
            <div class="bg-white p-2 rounded-lg">
                <i class="fas fa-cog text-blue-600"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold">Admin Panel</h1>
                <p class="text-xs opacity-90">HR Conclave 2026</p>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="gradient-bg text-white shadow-lg hidden md:block">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <div class="bg-white p-2 rounded-lg">
                        <i class="fas fa-cog text-xl text-blue-600"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Admin Panel</h1>
                        <p class="text-sm opacity-90">HR Conclave 2026 Management</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="text-right hidden md:block">
                        <p class="font-medium">{{ session.get('name', 'Admin') }}</p>
                        <p class="text-sm opacity-75">Administrator</p>
                    </div>
                    <div class="w-10 h-10">
                        <i class="fas fa-user"></i>
                    </div>
                    <a href="{{ url_for('admin_logout') }}" 
                       class="bg-white text-blue-600 px-4 py-2 rounded-lg font-medium hover:bg-blue-50 transition">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Sidebar Overlay -->
    <div id="mobileSidebarOverlay" class="mobile-sidebar-overlay" onclick="closeMobileSidebar()"></div>

    <!-- Mobile Sidebar Panel -->
    <div id="mobileSidebarPanel" class="mobile-sidebar-panel md:hidden">
        <!-- Close Button Header -->
        <div class="sticky top-0 bg-gray-800 p-4 flex justify-between items-center border-b border-gray-700">
            <h2 class="text-lg font-bold">Navigation</h2>
            <button onclick="closeMobileSidebar()" 
                    class="text-white hover:text-gray-300 p-2 rounded-full hover:bg-gray-700 transition-colors"
                    aria-label="Close menu">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <!-- Menu Items -->
        <div class="p-4 overflow-y-auto" style="height: calc(100vh - 72px)">
            <div class="space-y-1 mb-6">
                <a href="{{ url_for('admin_dashboard') }}" 
                   class="flex items-center py-3 px-4 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-home mr-3 w-5 text-center"></i>
                    <span>Overview</span>
                </a>
                <a href="{{ url_for('admin_upload_hr') }}" 
                   class="flex items-center py-3 px-4 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-upload mr-3 w-5 text-center"></i>
                    <span>Upload HR Data</span>
                </a>
                <a href="{{ url_for('admin_panel_discussion') }}"           
                   class="flex items-center py-3 px-4 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-comments mr-3 w-5 text-center"></i>
                    <span>Discussion Panel</span>
                </a>
                <a href="{{ url_for('admin_invitations') }}" 
                   class="flex items-center py-3 px-4 rounded-lg bg-gray-700 transition">
                    <i class="fas fa-envelope mr-3 w-5 text-center"></i>
                    <span>Invitations</span>
                    {% if pending_invitations|length > 0 %}
                    <span class="ml-auto bg-red-500 text-white text-xs px-2 py-1 rounded-full">
                        {{ pending_invitations|length }}
                    </span>
                    {% endif %}
                </a>
                <a href="{{ url_for('admin_registrations') }}" 
                   class="flex items-center py-3 px-4 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-users mr-3 w-5 text-center"></i>
                    <span>Registrations</span>
                    {% set registered_count = total_registrations if total_registrations is defined else 0 %}
                    <span class="ml-auto bg-green-500 text-white text-xs px-2 py-1 rounded-full">
                        {{ registered_count }}
                    </span>
                </a>
                <a href="{{ url_for('admin_map') }}" 
                   class="flex items-center py-3 px-4 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-map mr-3 w-5 text-center"></i>
                    <span>Campus Map</span>
                </a>
                <a href="{{ url_for('admin_confirmations') }}" 
                   class="flex items-center py-3 px-4 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-check mr-3 w-5 text-center"></i>
                    <span>Confirmations</span>
                </a>
            </div>
            
            <!-- Quick Actions Section -->
            <div class="pt-6 border-t border-gray-700">
                <h3 class="text-sm font-bold mb-3 text-gray-400 px-4">Quick Actions</h3>
                <div class="space-y-1">
                    <a href="{{ url_for('admin_dashboard') }}" 
                       class="flex items-center py-2 px-4 bg-gray-700 hover:bg-gray-600 rounded-lg transition text-sm">
                        <i class="fas fa-arrow-left mr-2"></i>
                        <span>Back to Dashboard</span>
                    </a>
                    <a href="{{ url_for('admin_logout') }}" 
                       class="flex items-center py-2 px-4 bg-red-700 hover:bg-red-600 rounded-lg transition text-sm">
                        <i class="fas fa-sign-out-alt mr-2"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
            
            <!-- User Info Footer -->
            <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-700 bg-gray-800">
                <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center mr-3">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <div>
                        <p class="font-medium text-sm">{{ session.get('name', 'Admin') }}</p>
                        <p class="text-xs text-gray-400">Administrator</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Menu Button -->
    <button id="mobileMenuButton" class="mobile-menu-button md:hidden">
        <i class="fas fa-bars"></i>
    </button>

    <div class="flex pt-16 md:pt-0">
        <!-- Sidebar for Desktop -->
        <div class="w-64 bg-gray-800 text-white sidebar hidden md:block">
            <div class="p-6">
                <h2 class="text-lg font-bold mb-6 flex items-center">
                    <i class="fas fa-tachometer-alt mr-3"></i>Dashboard
                </h2>
                
                <div class="space-y-2">
                    <a href="{{ url_for('admin_dashboard') }}" 
                       class="sidebar-link block py-2 px-4 rounded-lg">
                        <i class="fas fa-home mr-3"></i>Overview
                    </a>

                    <a href="{{ url_for('admin_upload_hr') }}" 
                       class="sidebar-link block py-2 px-4 rounded-lg">
                        <i class="fas fa-upload mr-3"></i>Upload HR Data
                    </a>

                    <a href="{{ url_for('admin_panel_discussion') }}"            
                       class="sidebar-link block py-2 px-4 rounded-lg">
                        <i class="fas fa-comments mr-3"></i>Discussion Panel
                    </a>

                    <a href="{{ url_for('admin_invitations') }}" 
                       class="sidebar-link active block py-2 px-4 rounded-lg">
                        <i class="fas fa-envelope mr-3"></i>Invitations
                        {% if pending_invitations|length > 0 %}
                        <span class="float-right bg-red-500 text-white text-xs px-2 py-1 rounded-full">
                            {{ pending_invitations|length }}
                        </span>
                        {% endif %}
                    </a>
                    
                    <a href="{{ url_for('admin_registrations') }}" 
                       class="sidebar-link block py-2 px-4 rounded-lg">
                        <i class="fas fa-users mr-3"></i>Registrations
                        {% set registered_count = total_registrations if total_registrations is defined else 0 %}
                        <span class="float-right bg-green-500 text-white text-xs px-2 py-1 rounded-full">
                            {{ registered_count }}
                        </span>
                    </a>
                    
                    <a href="{{ url_for('admin_map') }}" 
                       class="sidebar-link block py-2 px-4 rounded-lg">
                        <i class="fas fa-map mr-3"></i>Campus Map
                    </a>

                    <a href="{{ url_for('admin_confirmations') }}" 
                       class="sidebar-link block py-2 px-4 rounded-lg">
                        <i class="fas fa-check mr-3"></i>Confirmations
                    </a>
                </div>
                
                <div class="mt-12 pt-6 border-t border-gray-700">
                    <h3 class="text-sm font-bold mb-3 text-gray-400">Quick Actions</h3>
                    <div class="space-y-2">
                        <a href="{{ url_for('admin_dashboard') }}" 
                           class="block py-2 px-4 bg-gray-700 hover:bg-gray-600 rounded-lg transition text-sm">
                            <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                        </a>
                        <a href="{{ url_for('index') }}" 
                           class="block py-2 px-4 bg-gray-700 hover:bg-gray-600 rounded-lg transition text-sm">
                            <i class="fas fa-external-link-alt mr-2"></i>View Public Site
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-4 md:p-6 w-full">
            <!-- Page Header -->
            <div class="mb-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Invitations Management</h1>
                        <p class="text-gray-600">Send invitations and reminders to HR professionals</p>
                    </div>
                    <div class="flex flex-wrap gap-3">
                        <div class="text-right">
                            <p class="text-sm text-gray-500">Quick Stats</p>
                            <p class="font-bold text-gray-800 text-sm">
                                Pending: {{ pending_invitations|length }} | 
                                Sent: {{ sent_invitations|length }} | 
                                Completed: {{ completed_invitations|length }} |
                                Registered: {{ total_registrations if total_registrations is defined else 0 }}
                            </p>
                        </div>
                        <a href="{{ url_for('admin_dashboard') }}" 
                           class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition">
                            <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>

            <!-- Email Messaging Center -->
            <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-envelope-open-text mr-3"></i>Email Messaging Center
                </h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Left Column - Email Composer -->
                    <div class="lg:col-span-2">
                        <div class="space-y-6">
                            <!-- Email Template Selection -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-file-alt mr-2"></i>Select Email Template
                                </label>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div class="email-template-card" onclick="selectEmailTemplate('invitation')" id="templateInvitation">
                                        <div class="flex items-center mb-2">
                                            <input type="radio" name="emailTemplate" value="invitation" checked class="mr-2">
                                            <h3 class="font-bold text-gray-800">Invitation Email</h3>
                                        </div>
                                        <p class="text-sm text-gray-600 mb-3">Send initial invitation to HR professionals</p>
                                        <div class="template-preview">
                                            <p><strong>Subject:</strong> Invitation | HR Conclave 2026</p>
                                            <p><strong>Use for:</strong> New recipients who haven't received any invitation</p>
                                        </div>
                                    </div>
                                    
                                    <div class="email-template-card" onclick="selectEmailTemplate('reminder')" id="templateReminder">
                                        <div class="flex items-center mb-2">
                                            <input type="radio" name="emailTemplate" value="reminder" class="mr-2">
                                            <h3 class="font-bold text-gray-800">Reminder Email</h3>
                                        </div>
                                        <p class="text-sm text-gray-600 mb-3">Send reminder to those who haven't registered yet</p>
                                        <div class="template-preview">
                                            <p><strong>Subject:</strong> Reminder | HR Conclave 2026</p>
                                            <p><strong>Use for:</strong> Sent invitations that haven't been completed</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- File Attachments -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-paperclip mr-2"></i>Attachments (Optional, Max 3 files)
                                </label>
                                <div class="mb-2 text-xs text-gray-500">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Upload up to 3 files: Images (JPEG, PNG, GIF), PDFs, Documents (DOC, XLS, PPT), or ZIP files
                                    <br>
                                    <span class="text-red-500">Maximum 10MB per file</span>
                                </div>
                                <div class="file-upload-area" onclick="document.getElementById('fileUpload').click()">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-gray-600 mb-1">Click to upload files (Optional)</p>
                                    <p class="text-sm text-gray-500">Drag & drop or click to select files</p>
                                    <div class="mt-2 text-xs text-gray-400">
                                        <div>✓ Images: JPEG, PNG, GIF, BMP, WebP</div>
                                        <div>✓ Documents: PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX</div>
                                        <div>✓ Other: TXT, CSV, ZIP</div>
                                    </div>
                                    <input type="file" id="fileUpload" multiple class="hidden" 
                                           onchange="handleFileUpload(event)" 
                                           accept=".jpg,.jpeg,.png,.gif,.bmp,.webp,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.zip">
                                </div>
                                
                                <!-- File Preview -->
                                <div id="filePreview" class="mt-3 space-y-2">
                                    <div id="fileCounter" class="text-xs text-gray-500 mb-2 hidden">
                                        <span id="currentFileCount">0</span>/3 files selected
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column - Recipient Selection -->
                    <div class="lg:col-span-1">
                        <!-- Desktop Recipient Selection -->
                        <div class="hidden lg:block space-y-4">
                            <!-- Recipient Type Selection -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                                    <i class="fas fa-users mr-2"></i>Select Recipients
                                </h3>
                                <div class="space-y-2">
                                    <label class="flex items-center p-2 hover:bg-white rounded cursor-pointer">
                                        <input type="radio" name="recipientType" value="new" 
                                               class="mr-2" onchange="updateRecipientSelection()">
                                        <span class="text-sm">
                                            <span class="font-medium">New (No Invitation Sent)</span>
                                            <span class="text-gray-500 text-xs block">
                                                {% set new_count = 0 %}
                                                {% for hr in pending_invitations %}
                                                    {% if not hr.get('invitation_sent') %}
                                                        {% set new_count = new_count + 1 %}
                                                    {% endif %}
                                                {% endfor %}
                                                {{ new_count }} new recipients
                                            </span>
                                        </span>
                                    </label>
                                    
                                    <label class="flex items-center p-2 hover:bg-white rounded cursor-pointer">
                                        <input type="radio" name="recipientType" value="pending" checked 
                                               class="mr-2" onchange="updateRecipientSelection()">
                                        <span class="text-sm">
                                            <span class="font-medium">All Pending</span>
                                            <span class="text-gray-500 text-xs block">{{ pending_invitations|length }} HR</span>
                                        </span>
                                    </label>
                                    
                                    <label class="flex items-center p-2 hover:bg-white rounded cursor-pointer">
                                        <input type="radio" name="recipientType" value="sent" 
                                               class="mr-2" onchange="updateRecipientSelection()">
                                        <span class="text-sm">
                                            <span class="font-medium">All Sent</span>
                                            <span class="text-gray-500 text-xs block">{{ sent_invitations|length }} sent</span>
                                        </span>
                                    </label>
                                    
                                    <label class="flex items-center p-2 hover:bg-white rounded cursor-pointer">
                                        <input type="radio" name="recipientType" value="completed" 
                                               class="mr-2" onchange="updateRecipientSelection()">
                                        <span class="text-sm">
                                            <span class="font-medium">All Completed</span>
                                            <span class="text-gray-500 text-xs block">{{ completed_invitations|length }} completed</span>
                                        </span>
                                    </label>
                                    
                                    <label class="flex items-center p-2 hover:bg-white rounded cursor-pointer">
                                        <input type="radio" name="recipientType" value="registered" 
                                               class="mr-2" onchange="updateRecipientSelection()">
                                        <span class="text-sm">
                                            <span class="font-medium">All Registered</span>
                                            <span class="text-gray-500 text-xs block">{{ total_registrations if total_registrations is defined else 0 }} registered</span>
                                        </span>
                                    </label>
                                    
                                    <label class="flex items-center p-2 hover:bg-white rounded cursor-pointer">
                                        <input type="radio" name="recipientType" value="custom" 
                                               class="mr-2" onchange="updateRecipientSelection()">
                                        <span class="text-sm font-medium">Custom Selection</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Selected Recipients Display -->
                            <div id="selectedRecipientsDisplay" class="bg-gray-50 rounded-lg p-4 hidden">
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="text-sm font-medium text-gray-700">Selected Recipients</h3>
                                    <button onclick="clearRecipientSelection()" class="text-xs text-red-600 hover:text-red-800">
                                        Clear All
                                    </button>
                                </div>
                                <div id="recipientBadges" class="flex flex-wrap gap-1 mb-2"></div>
                                <p id="selectedCountText" class="text-sm text-gray-500"></p>
                            </div>
                            
                            <!-- Send Button -->
                            <button onclick="sendBulkEmail()" 
                                    class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white px-4 py-3 rounded-lg font-medium hover:opacity-90 transition shadow-lg">
                                <i class="fas fa-paper-plane mr-2"></i>Send Email
                            </button>
                        </div>
                        
                        <!-- Mobile Recipient Selection Button -->
                        <div class="lg:hidden">
                            <button onclick="openMobileRecipientPanel()" 
                                    class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-blue-700 transition flex items-center justify-center">
                                <i class="fas fa-users mr-2"></i>Select Recipients
                                <span id="mobileSelectedCount" class="ml-2 bg-white text-blue-600 text-xs px-2 py-1 rounded-full hidden">0</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="bg-white rounded-xl shadow-lg p-2 mb-6">
                <div class="flex flex-wrap gap-2">
                    <button id="tabNew" class="tab-button active" onclick="showTab('new')">
                        <i class="fas fa-user-plus mr-2"></i>New (No Invitation)
                        {% set new_count = 0 %}
                        {% for hr in pending_invitations %}
                            {% if not hr.get('invitation_sent') %}
                                {% set new_count = new_count + 1 %}
                            {% endif %}
                        {% endfor %}
                        {% if new_count > 0 %}
                        <span class="ml-2 bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">
                            {{ new_count }}
                        </span>
                        {% endif %}
                    </button>
                    
                    <button id="tabPending" class="tab-button" onclick="showTab('pending')">
                        <i class="fas fa-clock mr-2"></i>Pending
                        {% if pending_invitations %}
                        <span class="ml-2 bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full">
                            {{ pending_invitations|length }}
                        </span>
                        {% endif %}
                    </button>
                    
                    <button id="tabSent" class="tab-button" onclick="showTab('sent')">
                        <i class="fas fa-paper-plane mr-2"></i>Sent
                        {% if sent_invitations %}
                        <span class="ml-2 bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                            {{ sent_invitations|length }}
                        </span>
                        {% endif %}
                    </button>
                    
                    <button id="tabCompleted" class="tab-button" onclick="showTab('completed')">
                        <i class="fas fa-check-circle mr-2"></i>Completed
                        {% if completed_invitations %}
                        <span class="ml-2 bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">
                            {{ completed_invitations|length }}
                        </span>
                        {% endif %}
                    </button>
                    
                    <button id="tabRegistered" class="tab-button" onclick="showTab('registered')">
                        <i class="fas fa-user-check mr-2"></i>Registered
                        {% if total_registrations %}
                        <span class="ml-2 bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">
                            {{ total_registrations }}
                        </span>
                        {% endif %}
                    </button>
                    
                    <button id="tabAll" class="tab-button" onclick="showTab('all')">
                        <i class="fas fa-list mr-2"></i>All HR
                        <span class="ml-2 bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded-full">
                            {{ (pending_invitations|length + sent_invitations|length + completed_invitations|length + total_registrations)|default(0) }}
                        </span>
                    </button>
                </div>
            </div>

            <!-- Tab Content: New (No Invitation Sent) -->
            <div id="tabContentNew" class="tab-content">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="p-4 md:p-6 border-b border-gray-200">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">New Recipients - No Invitation Sent</h3>
                                <p class="text-gray-600">HR professionals who have never received an invitation</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="selectAllInTab('new')" 
                                        class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-300">
                                    Select All
                                </button>
                                <button onclick="sendAllNew()" 
                                        class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">
                                    <i class="fas fa-paper-plane mr-2"></i>Send Invitations to All New
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {% if pending_invitations %}
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-12">
                                        <input type="checkbox" class="checkbox-round" id="selectAllNew" 
                                               onchange="toggleAllNew(this.checked)">
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">HR Professional</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Contact Info</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                {% for hr in pending_invitations %}
                                {% if not hr.get('invitation_sent') %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3">
                                        <input type="checkbox" class="checkbox-round hr-checkbox new-checkbox" 
                                               data-hr-id="{{ hr.id }}" 
                                               data-hr-name="{{ hr.get('full_name', '') }}" 
                                               data-hr-email="{{ hr.get('office_email', 'N/A') }}" 
                                               data-hr-org="{{ hr.get('organization', 'N/A') }}"
                                               data-hr-greeting="{% if hr.get('full_name') %}{{ hr.get('full_name') }}{% else %}{{ hr.get('organization', 'N/A') }} Team{% endif %}">
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="font-medium text-gray-900">
                                            {% if hr.get('full_name') and hr.get('full_name') != 'N/A' %}
                                                {{ hr.get('full_name', 'N/A') }}
                                            {% else %}
                                                <span class="text-blue-600">{{ hr.get('organization', 'N/A') }} Team</span>
                                            {% endif %}
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            {% if hr.get('full_name') and hr.get('full_name') != 'N/A' %}
                                                {{ hr.get('designation', 'N/A') }}{% if hr.get('organization') %}, {{ hr.get('organization', 'N/A') }}{% endif %}
                                            {% else %}
                                                {{ hr.get('organization', 'N/A') }}
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="text-sm">{{ hr.get('office_email', 'N/A') }}</div>
                                        {% if hr.get('mobile') %}
                                        <div class="text-sm text-gray-500">{{ hr.get('mobile', '') }}</div>
                                        {% endif %}
                                        {% if hr.get('uploaded_at') %}
                                        <div class="text-xs text-gray-400 mt-1">
                                            {% if hr.get('uploaded_at')|length >= 10 %}
                                                Added: {{ hr.get('uploaded_at', '')[:10] }}
                                            {% else %}
                                                Added: {{ hr.get('uploaded_at', '') }}
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="status-badge status-pending">
                                            <i class="fas fa-clock mr-1"></i> Not Invited
                                        </span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="flex gap-2">
                                            <button onclick="sendSingleInvitation('{{ hr.id }}', '{{ hr.get("full_name", hr.get("organization", "HR")) }}')" 
                                                    class="text-blue-600 hover:text-blue-900">
                                                <i class="fas fa-paper-plane"></i> Send Invitation
                                            </button>
                                            <button onclick="viewHRDetails('{{ hr.id }}')" 
                                                    class="text-gray-600 hover:text-gray-900">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-12">
                        <i class="fas fa-inbox text-5xl text-gray-300 mb-4"></i>
                        <h4 class="text-xl font-bold text-gray-500 mb-2">No New HR Data</h4>
                        <p class="text-gray-500 mb-6">All uploaded HR data has been invited or no data exists.</p>
                        <a href="{{ url_for('admin_upload_hr') }}" 
                           class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition">
                            <i class="fas fa-upload mr-2"></i>Upload HR Data
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Tab Content: Pending -->
            <div id="tabContentPending" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="p-4 md:p-6 border-b border-gray-200">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Uploaded HR Data</h3>
                                <p class="text-gray-600">HR professionals added via upload but invitations not sent yet</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="selectAllInTab('pending')" 
                                        class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-300">
                                    Select All
                                </button>
                                <button onclick="sendAllPending()" 
                                        class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">
                                    <i class="fas fa-paper-plane mr-2"></i>Send All Invitations
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {% if pending_invitations %}
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-12">
                                        <input type="checkbox" class="checkbox-round" id="selectAllPending" 
                                               onchange="toggleAllPending(this.checked)">
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">HR Professional</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Contact Info</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                {% for hr in pending_invitations %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3">
                                        <input type="checkbox" class="checkbox-round hr-checkbox pending-checkbox" 
                                               data-hr-id="{{ hr.id }}" 
                                               data-hr-name="{{ hr.get('full_name', '') }}" 
                                               data-hr-email="{{ hr.get('office_email', 'N/A') }}" 
                                               data-hr-org="{{ hr.get('organization', 'N/A') }}"
                                               data-hr-greeting="{% if hr.get('full_name') %}{{ hr.get('full_name') }}{% else %}{{ hr.get('organization', 'N/A') }} Team{% endif %}">
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="font-medium text-gray-900">
                                            {% if hr.get('full_name') and hr.get('full_name') != 'N/A' %}
                                                {{ hr.get('full_name', 'N/A') }}
                                            {% else %}
                                                <span class="text-blue-600">{{ hr.get('organization', 'N/A') }} Team</span>
                                            {% endif %}
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            {% if hr.get('full_name') and hr.get('full_name') != 'N/A' %}
                                                {{ hr.get('designation', 'N/A') }}{% if hr.get('organization') %}, {{ hr.get('organization', 'N/A') }}{% endif %}
                                            {% else %}
                                                {{ hr.get('organization', 'N/A') }}
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="text-sm">{{ hr.get('office_email', 'N/A') }}</div>
                                        {% if hr.get('mobile') %}
                                        <div class="text-sm text-gray-500">{{ hr.get('mobile', '') }}</div>
                                        {% endif %}
                                        {% if hr.get('uploaded_at') %}
                                        <div class="text-xs text-gray-400 mt-1">
                                            {% if hr.get('uploaded_at')|length >= 10 %}
                                                Added: {{ hr.get('uploaded_at', '')[:10] }}
                                            {% else %}
                                                Added: {{ hr.get('uploaded_at', '') }}
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="status-badge status-pending">
                                            <i class="fas fa-upload mr-1"></i> Uploaded
                                        </span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="flex gap-2">
                                            {% if not hr.get('invitation_sent') %}
                                            <button onclick="sendSingleInvitation('{{ hr.id }}', '{{ hr.get("full_name", hr.get("organization", "HR")) }}')" 
                                                    class="text-blue-600 hover:text-blue-900">
                                                <i class="fas fa-paper-plane"></i> Send Invitation
                                            </button>
                                            {% endif %}
                                            <button onclick="viewHRDetails('{{ hr.id }}')" 
                                                    class="text-gray-600 hover:text-gray-900">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-12">
                        <i class="fas fa-inbox text-5xl text-gray-300 mb-4"></i>
                        <h4 class="text-xl font-bold text-gray-500 mb-2">No Uploaded HR Data</h4>
                        <p class="text-gray-500 mb-6">No HR data has been uploaded yet. Upload HR data to send invitations.</p>
                        <a href="{{ url_for('admin_upload_hr') }}" 
                           class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition">
                            <i class="fas fa-upload mr-2"></i>Upload HR Data
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Tab Content: Sent -->
            <div id="tabContentSent" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="p-4 md:p-6 border-b border-gray-200">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Invitations Sent</h3>
                                <p class="text-gray-600">Invitation emails sent but registration not completed</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="selectAllInTab('sent')" 
                                        class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-300">
                                    Select All
                                </button>
                                <button onclick="resendAllSent()" 
                                        class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">
                                    <i class="fas fa-redo mr-2"></i>Resend All
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {% if sent_invitations %}
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-12">
                                        <input type="checkbox" class="checkbox-round" id="selectAllSent" 
                                               onchange="toggleAllSent(this.checked)">
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">HR Professional</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Invitation Details</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                {% for hr in sent_invitations %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3">
                                        <input type="checkbox" class="checkbox-round hr-checkbox sent-checkbox" 
                                               data-hr-id="{{ hr.id }}" 
                                               data-hr-name="{{ hr.get('full_name', '') }}" 
                                               data-hr-email="{{ hr.get('office_email', 'N/A') }}" 
                                               data-hr-org="{{ hr.get('organization', 'N/A') }}"
                                               data-hr-greeting="{% if hr.get('full_name') %}{{ hr.get('full_name') }}{% else %}{{ hr.get('organization', 'N/A') }} Team{% endif %}">
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="font-medium text-gray-900">
                                            {% if hr.get('full_name') and hr.get('full_name') != 'N/A' %}
                                                {{ hr.get('full_name', 'N/A') }}
                                            {% else %}
                                                <span class="text-blue-600">{{ hr.get('organization', 'N/A') }} Team</span>
                                            {% endif %}
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            {% if hr.get('full_name') and hr.get('full_name') != 'N/A' %}
                                                {{ hr.get('designation', 'N/A') }}{% if hr.get('organization') %}, {{ hr.get('organization', 'N/A') }}{% endif %}
                                            {% else %}
                                                {{ hr.get('organization', 'N/A') }}
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="text-sm">{{ hr.get('office_email', 'N/A') }}</div>
                                        {% if hr.get('invitation_sent_at') %}
                                        <div class="text-xs text-gray-500">
                                            Sent: {{ hr.get('invitation_sent_at', '')[:10] }}
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="status-badge status-sent">
                                            <i class="fas fa-paper-plane mr-1"></i> Sent
                                        </span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="flex gap-2">
                                            <button onclick="resendSingleInvitation('{{ hr.id }}', '{{ hr.get("full_name", hr.get("organization", "HR")) }}')" 
                                                    class="text-blue-600 hover:text-blue-900">
                                                <i class="fas fa-redo"></i>
                                            </button>
                                            <button onclick="copyInvitationLink('{{ hr.get("invitation_url", "") }}')" 
                                                    class="text-green-600 hover:text-green-900">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-12">
                        <i class="fas fa-paper-plane text-5xl text-gray-300 mb-4"></i>
                        <h4 class="text-xl font-bold text-gray-500 mb-2">No Sent Invitations</h4>
                        <p class="text-gray-500">No invitations have been sent or all have been completed</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Tab Content: Completed -->
            <div id="tabContentCompleted" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="p-4 md:p-6 border-b border-gray-200">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Completed Registrations</h3>
                                <p class="text-gray-600">Invitation recipients who completed registration</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="selectAllInTab('completed')" 
                                        class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-300">
                                    Select All
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {% if completed_invitations %}
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-12">
                                        <input type="checkbox" class="checkbox-round" id="selectAllCompleted" 
                                               onchange="toggleAllCompleted(this.checked)">
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">HR Professional</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Registration Details</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                {% for hr in completed_invitations %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3">
                                        <input type="checkbox" class="checkbox-round hr-checkbox completed-checkbox" 
                                               data-hr-id="{{ hr.id }}" 
                                               data-hr-name="{{ hr.get('full_name', '') }}" 
                                               data-hr-email="{{ hr.get('office_email', 'N/A') }}" 
                                               data-hr-org="{{ hr.get('organization', 'N/A') }}"
                                               data-hr-greeting="{% if hr.get('full_name') %}{{ hr.get('full_name') }}{% else %}{{ hr.get('organization', 'N/A') }} Team{% endif %}">
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="font-medium text-gray-900">
                                            {% if hr.get('full_name') and hr.get('full_name') != 'N/A' %}
                                                {{ hr.get('full_name', 'N/A') }}
                                            {% else %}
                                                <span class="text-blue-600">{{ hr.get('organization', 'N/A') }} Team</span>
                                            {% endif %}
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            {% if hr.get('full_name') and hr.get('full_name') != 'N/A' %}
                                                {{ hr.get('designation', 'N/A') }}{% if hr.get('organization') %}, {{ hr.get('organization', 'N/A') }}{% endif %}
                                            {% else %}
                                                {{ hr.get('organization', 'N/A') }}
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="text-sm">
                                            {% if hr.get('actual_registration_id') %}
                                            <div class="font-medium text-blue-600">{{ hr.get('actual_registration_id', '') }}</div>
                                            {% endif %}
                                            {{ hr.get('office_email', 'N/A') }}
                                        </div>
                                        {% if hr.get('completed_at') %}
                                        <div class="text-xs text-gray-500">
                                            Completed: {{ hr.get('completed_at', '')[:10] }}
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="status-badge status-completed">
                                            <i class="fas fa-check-circle mr-1"></i> Completed
                                        </span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="flex gap-2">
                                            <button onclick="viewHRDetails('{{ hr.id }}')" 
                                                    class="text-gray-600 hover:text-gray-900">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-12">
                        <i class="fas fa-check-circle text-5xl text-gray-300 mb-4"></i>
                        <h4 class="text-xl font-bold text-gray-500 mb-2">No Completed Registrations</h4>
                        <p class="text-gray-500">No invitation recipients have completed registration yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Tab Content: Registered -->
            <div id="tabContentRegistered" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="p-4 md:p-6 border-b border-gray-200">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Registered HR Professionals</h3>
                                <p class="text-gray-600">All HR professionals who have completed registration</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="selectAllInTab('registered')" 
                                        class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-300">
                                    Select All
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {% if registered_hrs %}
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-12">
                                        <input type="checkbox" class="checkbox-round" id="selectAllRegistered" 
                                               onchange="toggleAllRegistered(this.checked)">
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">HR Professional</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Registration Details</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                {% for hr in registered_hrs %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3">
                                        <input type="checkbox" class="checkbox-round hr-checkbox registered-checkbox" 
                                               data-hr-id="{{ hr.registration_id if hr.registration_id else hr.id }}" 
                                               data-hr-name="{{ hr.get('full_name', '') }}" 
                                               data-hr-email="{{ hr.get('office_email', 'N/A') }}" 
                                               data-hr-org="{{ hr.get('organization', 'N/A') }}"
                                               data-hr-greeting="{% if hr.get('full_name') %}{{ hr.get('full_name') }}{% else %}{{ hr.get('organization', 'N/A') }} Team{% endif %}">
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="font-medium text-gray-900">
                                            {% if hr.get('full_name') and hr.get('full_name') != 'N/A' %}
                                                {{ hr.get('full_name', 'N/A') }}
                                            {% else %}
                                                <span class="text-blue-600">{{ hr.get('organization', 'N/A') }} Team</span>
                                            {% endif %}
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            {% if hr.get('full_name') and hr.get('full_name') != 'N/A' %}
                                                {{ hr.get('designation', 'N/A') }}{% if hr.get('organization') %}, {{ hr.get('organization', 'N/A') }}{% endif %}
                                            {% else %}
                                                {{ hr.get('organization', 'N/A') }}
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="text-sm">
                                            <div class="font-medium text-blue-600">{{ hr.get('registration_id', 'N/A') }}</div>
                                            {{ hr.get('office_email', 'N/A') }}
                                        </div>
                                        {% if hr.get('registered_at') %}
                                        <div class="text-xs text-gray-500">
                                            Registered: {{ hr.get('registered_at', '')[:10] }}
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3">
                                        {% if hr.get('approval_status') == 'approved' %}
                                        <span class="status-badge status-approved">
                                            <i class="fas fa-check-circle mr-1"></i> Approved
                                        </span>
                                        {% else %}
                                        <span class="status-badge status-registered">
                                            <i class="fas fa-user-check mr-1"></i> Registered
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="flex gap-2">
                                            <button onclick="viewRegistrationDetails('{{ hr.registration_id if hr.registration_id else hr.id }}')" 
                                                    class="text-blue-600 hover:text-blue-900">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if hr.get('approval_status') == 'approved' %}
                                            <button onclick="resendConfirmationEmail('{{ hr.registration_id if hr.registration_id else hr.id }}')" 
                                                    class="text-green-600 hover:text-green-900">
                                                <i class="fas fa-envelope"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-12">
                        <i class="fas fa-users text-5xl text-gray-300 mb-4"></i>
                        <h4 class="text-xl font-bold text-gray-500 mb-2">No Registered HR Professionals</h4>
                        <p class="text-gray-500">No HR professionals have completed registration yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Tab Content: All -->
            <div id="tabContentAll" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="p-4 md:p-6 border-b border-gray-200">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">All HR Professionals</h3>
                                <p class="text-gray-600">Complete list of all HR professionals in the system</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="selectAllInTab('all')" 
                                        class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-300">
                                    Select All
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {% if all_hr_list %}
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-12">
                                        <input type="checkbox" class="checkbox-round" id="selectAll" 
                                               onchange="toggleAll(this.checked)">
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">HR Professional</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Details</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                {% for hr in all_hr_list %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3">
                                        <input type="checkbox" class="checkbox-round hr-checkbox all-checkbox" 
                                               data-hr-id="{{ hr.id }}" 
                                               data-hr-name="{{ hr.get('full_name', '') }}" 
                                               data-hr-email="{{ hr.get('office_email', 'N/A') }}" 
                                               data-hr-org="{{ hr.get('organization', 'N/A') }}"
                                               data-hr-greeting="{% if hr.get('full_name') %}{{ hr.get('full_name') }}{% else %}{{ hr.get('organization', 'N/A') }} Team{% endif %}">
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="font-medium text-gray-900">
                                            {% if hr.get('full_name') and hr.get('full_name') != 'N/A' %}
                                                {{ hr.get('full_name', 'N/A') }}
                                            {% else %}
                                                <span class="text-blue-600">{{ hr.get('organization', 'N/A') }} Team</span>
                                            {% endif %}
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            {% if hr.get('full_name') and hr.get('full_name') != 'N/A' %}
                                                {{ hr.get('designation', 'N/A') }}{% if hr.get('organization') %}, {{ hr.get('organization', 'N/A') }}{% endif %}
                                            {% else %}
                                                {{ hr.get('organization', 'N/A') }}
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="text-sm">
                                            {% if hr.get('registration_id') %}
                                            <div class="font-medium text-blue-600">{{ hr.get('registration_id', 'N/A') }}</div>
                                            {% endif %}
                                            {{ hr.get('office_email', 'N/A') }}
                                        </div>
                                        {% if hr.get('mobile') %}
                                        <div class="text-xs text-gray-500">{{ hr.get('mobile', '') }}</div>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3">
                                        <!-- NEW LOGIC: Check if registered (has registration_id) -->
                                        {% if hr.get('registration_id') %}
                                            {% if hr.get('approval_status') == 'approved' %}
                                            <span class="status-badge status-approved">
                                                <i class="fas fa-check-circle mr-1"></i> Approved
                                            </span>
                                            {% else %}
                                            <span class="status-badge status-registered">
                                                <i class="fas fa-user-check mr-1"></i> Registered
                                            </span>
                                            {% endif %}
                                        <!-- Check if registration completed from pending data -->
                                        {% elif hr.get('registration_complete') %}
                                            <span class="status-badge status-completed">
                                                <i class="fas fa-check-circle mr-1"></i> Completed
                                            </span>
                                        <!-- Check if invitation sent -->
                                        {% elif hr.get('invitation_sent') %}
                                            <span class="status-badge status-sent">
                                                <i class="fas fa-paper-plane mr-1"></i> Sent
                                            </span>
                                        <!-- Otherwise, pending (just uploaded) -->
                                        {% else %}
                                            <span class="status-badge status-pending">
                                                <i class="fas fa-clock mr-1"></i> Uploaded
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="flex gap-2">
                                            <!-- Show send invitation button only for uploaded (not sent) pending HR -->
                                            {% if not hr.get('invitation_sent') and not hr.get('registration_id') and not hr.get('registration_complete') %}
                                            <button onclick="sendSingleInvitation('{{ hr.id }}', '{{ hr.get("full_name", hr.get("organization", "HR")) }}')" 
                                                    class="text-blue-600 hover:text-blue-900">
                                                <i class="fas fa-paper-plane"></i>
                                            </button>
                                            {% endif %}
                                            <button onclick="viewHRDetails('{{ hr.id }}')" 
                                                    class="text-gray-600 hover:text-gray-900">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-12">
                        <i class="fas fa-users text-5xl text-gray-300 mb-4"></i>
                        <h4 class="text-xl font-bold text-gray-500 mb-2">No HR Professionals Found</h4>
                        <p class="text-gray-500">No HR data has been uploaded yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Mobile Recipient Panel (Bottom Sheet) -->
            <div id="mobileRecipientPanel" class="mobile-recipient-panel">
                <div class="sticky top-0 bg-white p-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Select Recipients</h3>
                            <p id="mobileSelectionInfo" class="text-sm text-gray-500">Choose who will receive this email</p>
                        </div>
                        <button onclick="closeMobileRecipientPanel()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                
                <div class="p-4">
                    <div class="space-y-3 mb-6">
                        <label class="recipient-option" onclick="selectMobileRecipientType('new')" id="mobileOptionNew">
                            <div class="w-5 h-5 rounded-full border-2 border-gray-300 mr-3 flex items-center justify-center">
                                <div class="w-3 h-3 rounded-full bg-blue-600 hidden"></div>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">New (No Invitation)</p>
                                {% set new_count = 0 %}
                                {% for hr in pending_invitations %}
                                    {% if not hr.get('invitation_sent') %}
                                        {% set new_count = new_count + 1 %}
                                    {% endif %}
                                {% endfor %}
                                <p class="text-sm text-gray-500">{{ new_count }} new recipients</p>
                            </div>
                            <span id="mobileNewCount" class="recipient-count">{{ new_count }} new</span>
                        </label>
                        
                        <label class="recipient-option" onclick="selectMobileRecipientType('pending')" id="mobileOptionPending">
                            <div class="w-5 h-5 rounded-full border-2 border-gray-300 mr-3 flex items-center justify-center">
                                <div class="w-3 h-3 rounded-full bg-blue-600 hidden"></div>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">All Pending</p>
                                <p class="text-sm text-gray-500">{{ pending_invitations|length }} HR professionals</p>
                            </div>
                            <span id="mobilePendingCount" class="recipient-count">{{ pending_invitations|length }} pending</span>
                        </label>
                        
                        <label class="recipient-option" onclick="selectMobileRecipientType('sent')" id="mobileOptionSent">
                            <div class="w-5 h-5 rounded-full border-2 border-gray-300 mr-3 flex items-center justify-center">
                                <div class="w-3 h-3 rounded-full bg-blue-600 hidden"></div>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">All Sent</p>
                                <p class="text-sm text-gray-500">{{ sent_invitations|length }} sent invitations</p>
                            </div>
                            <span id="mobileSentCount" class="recipient-count">{{ sent_invitations|length }} sent</span>
                        </label>
                        
                        <label class="recipient-option" onclick="selectMobileRecipientType('completed')" id="mobileOptionCompleted">
                            <div class="w-5 h-5 rounded-full border-2 border-gray-300 mr-3 flex items-center justify-center">
                                <div class="w-3 h-3 rounded-full bg-blue-600 hidden"></div>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">All Completed</p>
                                <p class="text-sm text-gray-500">{{ completed_invitations|length }} completed registrations</p>
                            </div>
                            <span id="mobileCompletedCount" class="recipient-count">{{ completed_invitations|length }} completed</span>
                        </label>
                        
                        <label class="recipient-option" onclick="selectMobileRecipientType('registered')" id="mobileOptionRegistered">
                            <div class="w-5 h-5 rounded-full border-2 border-gray-300 mr-3 flex items-center justify-center">
                                <div class="w-3 h-3 rounded-full bg-blue-600 hidden"></div>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">All Registered</p>
                                <p class="text-sm text-gray-500">{{ total_registrations if total_registrations is defined else 0 }} registered</p>
                            </div>
                            <span id="mobileRegisteredCount" class="recipient-count">{{ total_registrations if total_registrations is defined else 0 }} registered</span>
                        </label>
                        
                        <label class="recipient-option" onclick="showCustomSelectionModal()" id="mobileOptionCustom">
                            <div class="w-5 h-5 rounded-full border-2 border-gray-300 mr-3 flex items-center justify-center">
                                <div class="w-3 h-3 rounded-full bg-blue-600 hidden"></div>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">Custom Selection</p>
                                <p class="text-sm text-gray-500">Select specific HR professionals</p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </label>
                    </div>
                    
                    <!-- Selected Recipients Display for Mobile -->
                    <div id="mobileRecipientsDisplay" class="mb-6 hidden">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-sm font-medium text-gray-700">Selected Recipients</h4>
                            <button onclick="clearRecipientSelection()" class="text-xs text-red-600 hover:text-red-800">
                                Clear All
                            </button>
                        </div>
                        <div id="mobileRecipientBadges" class="flex flex-wrap gap-1 mb-2"></div>
                        <p id="mobileSelectedCountText" class="text-sm text-gray-500"></p>
                    </div>
                    
                    <button id="mobileApplyButton" onclick="applyMobileSelection()" 
                            class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        <i class="fas fa-check mr-2"></i>Apply Selection
                        <span id="mobileSelectedCountBadge" class="ml-2 bg-white text-blue-600 text-xs px-2 py-1 rounded-full hidden">0</span>
                    </button>
                </div>
            </div>

            <!-- Custom Selection Modal -->
            <div id="customSelectionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden modal-enter">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-bold text-gray-800">Custom Recipient Selection</h3>
                            <button onclick="hideCustomSelectionModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                        <p class="text-gray-600 mt-2">Select specific HR professionals to receive this email</p>
                        
                        <!-- Search and Filter -->
                        <div class="mt-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="md:col-span-2">
                                    <input type="text" id="hrSearch" 
                                           class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                           placeholder="Search by name, email, organization..." 
                                           onkeyup="filterHRList()">
                                </div>
                                <div>
                                    <select id="hrFilter" 
                                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            onchange="filterHRList()">
                                        <option value="all">All Status</option>
                                        <option value="new">New (No Invitation)</option>
                                        <option value="pending">Pending Only</option>
                                        <option value="sent">Sent Only</option>
                                        <option value="completed">Completed Only</option>
                                        <option value="registered">Registered Only</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6 overflow-y-auto max-h-[60vh]">
                        <!-- HR List -->
                        <div id="hrListContainer" class="space-y-3">
                            <!-- HR items will be dynamically loaded here -->
                        </div>
                    </div>
                    
                    <div class="p-6 border-t border-gray-200 bg-gray-50 flex justify-between items-center">
                        <div>
                            <span id="modalSelectedCount" class="text-sm text-gray-700">0 selected</span>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="hideCustomSelectionModal()" 
                                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                Cancel
                            </button>
                            <button onclick="applyCustomSelection()" 
                                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                Apply Selection
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Modal -->
            <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2" id="loadingMessage">Sending emails...</h3>
                        <p class="text-sm text-gray-600" id="progressText">0/0 sent</p>
                        <p class="text-xs text-gray-500 mt-2">Please don't close this window</p>
                    </div>
                </div>
            </div>

            <!-- Success Modal -->
            <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-check text-green-600 text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2" id="successMessage">Emails sent successfully!</h3>
                        <p class="text-sm text-gray-600 mb-4" id="successDetails">All emails have been sent successfully.</p>
                        <button onclick="hideSuccessModal()" 
                                class="bg-blue-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-blue-700 transition">
                            OK
                        </button>
                    </div>
                </div>
            </div>

            <!-- Email History -->
            <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-history mr-2"></i>Email History
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Subject</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Recipients</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="emailHistoryTable">
                            <!-- Email history will be loaded here dynamically -->
                            <tr>
                                <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                                    <i class="fas fa-envelope-open-text text-3xl mb-3"></i>
                                    <p>No email history yet</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
<script>
    // Global variables
    let selectedHRs = new Set();
    let selectedHRsData = new Map();
    let uploadedFiles = [];
    let currentEmailTemplate = 'invitation'; // Default template
    let selectedRecipientType = 'pending'; // Default selection

    // ========== FILE UPLOAD FUNCTIONS ==========
    function handleFileUpload(event) {
        const files = Array.from(event.target.files);
        const maxFiles = 3;
        const maxSize = 10 * 1024 * 1024; // 10MB
        
        if (uploadedFiles.length + files.length > maxFiles) {
            showNotification('error', `Maximum ${maxFiles} files allowed. You can upload ${maxFiles - uploadedFiles.length} more file(s).`);
            return;
        }
        
        files.forEach(file => {
            if (file.size > maxSize) {
                showNotification('error', `File ${file.name} exceeds 10MB limit`);
                return;
            }
            
            const allowedTypes = [
                'image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'image/bmp',
                'application/pdf',
                'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'application/vnd.ms-powerpoint', 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                'text/plain', 'text/csv',
                'application/zip', 'application/x-zip-compressed'
            ];
            
            if (!allowedTypes.includes(file.type)) {
                showNotification('error', `File type not supported for ${file.name}`);
                return;
            }
            
            uploadedFiles.push(file);
            addFilePreview(file);
        });
        
        updateFileCounter();
        event.target.value = '';
    }

    function addFilePreview(file) {
        const previewContainer = document.getElementById('filePreview');
        const fileId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        
        const fileElement = document.createElement('div');
        fileElement.className = 'attachment-preview';
        fileElement.id = `file-${fileId}`;
        
        let icon = 'fa-file';
        let iconColor = '#6b7280';
        let iconClass = 'fas';
        
        if (file.type.startsWith('image/')) {
            icon = 'fa-image';
            iconColor = '#3b82f6';
        } else if (file.type === 'application/pdf') {
            icon = 'fa-file-pdf';
            iconColor = '#ef4444';
        } else if (file.type.includes('word') || file.type.includes('document')) {
            icon = 'fa-file-word';
            iconColor = '#2563eb';
        } else if (file.type.includes('excel') || file.type.includes('spreadsheet')) {
            icon = 'fa-file-excel';
            iconColor = '#10b981';
        } else if (file.type.includes('powerpoint') || file.type.includes('presentation')) {
            icon = 'fa-file-powerpoint';
            iconColor = '#f59e0b';
        } else if (file.type.includes('zip') || file.type.includes('compressed')) {
            icon = 'fa-file-archive';
            iconColor = '#8b5cf6';
        } else if (file.type.includes('text') || file.type.includes('csv')) {
            icon = 'fa-file-alt';
            iconColor = '#6b7280';
        }
        
        fileElement.innerHTML = `
            <div class="attachment-icon" style="color: ${iconColor};">
                <i class="${iconClass} ${icon}"></i>
            </div>
            <div class="attachment-info">
                <div class="attachment-name" title="${file.name}">${file.name}</div>
                <div class="attachment-size">${formatFileSize(file.size)} • ${getFileExtension(file.name)}</div>
            </div>
            <button onclick="removeFile('${fileId}')" class="text-gray-400 hover:text-red-500">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'w-12 h-12 object-cover rounded ml-3';
                img.style.maxWidth = '50px';
                img.style.maxHeight = '50px';
                fileElement.querySelector('.attachment-info').appendChild(img);
            };
            reader.readAsDataURL(file);
        }
        
        previewContainer.appendChild(fileElement);
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function getFileExtension(filename) {
        return filename.slice((filename.lastIndexOf(".") - 1 >>> 0) + 2).toUpperCase();
    }

    function removeFile(fileId) {
        const element = document.getElementById(`file-${fileId}`);
        if (element) {
            const fileName = element.querySelector('.attachment-name').textContent;
            uploadedFiles = uploadedFiles.filter(file => file.name !== fileName);
            element.remove();
            updateFileCounter();
        }
    }

    function updateFileCounter() {
        const counter = document.getElementById('fileCounter');
        const currentCount = document.getElementById('currentFileCount');
        
        if (uploadedFiles.length > 0) {
            currentCount.textContent = uploadedFiles.length;
            counter.classList.remove('hidden');
        } else {
            counter.classList.add('hidden');
        }
    }

    // ========== EMAIL TEMPLATE SELECTION ==========
    function selectEmailTemplate(template) {
        currentEmailTemplate = template;
        
        // Update UI
        document.querySelectorAll('.email-template-card').forEach(card => {
            card.classList.remove('selected');
        });
        document.getElementById(`template${template.charAt(0).toUpperCase() + template.slice(1)}`).classList.add('selected');
        
        // Update radio button
        document.querySelector(`input[name="emailTemplate"][value="${template}"]`).checked = true;
        
        showNotification('info', `Selected ${template === 'invitation' ? 'Invitation' : 'Reminder'} template`);
    }


    // ========== RECIPIENT SELECTION FUNCTIONS ==========
    function updateRecipientSelection() {
        const selectedType = document.querySelector('input[name="recipientType"]:checked').value;
        selectedRecipientType = selectedType;
        
        // Clear current selection
        selectedHRs.clear();
        selectedHRsData.clear();
        
        // Uncheck all checkboxes
        document.querySelectorAll('.hr-checkbox').forEach(cb => {
            cb.checked = false;
        });
        
        // Check appropriate checkboxes based on selection
        if (selectedType === 'new') {
            // Select all new (no invitation sent) checkboxes
            document.querySelectorAll('.new-checkbox').forEach(cb => {
                cb.checked = true;
                const hrId = cb.dataset.hrId;
                selectedHRs.add(hrId);
                selectedHRsData.set(hrId, {
                    id: hrId,
                    full_name: cb.dataset.hrName,
                    office_email: cb.dataset.hrEmail,
                    organization: cb.dataset.hrOrg,
                    greeting: cb.dataset.hrGreeting
                });
            });
        } else if (selectedType === 'pending') {
            // Select all pending checkboxes
            document.querySelectorAll('.pending-checkbox').forEach(cb => {
                cb.checked = true;
                const hrId = cb.dataset.hrId;
                selectedHRs.add(hrId);
                selectedHRsData.set(hrId, {
                    id: hrId,
                    full_name: cb.dataset.hrName,
                    office_email: cb.dataset.hrEmail,
                    organization: cb.dataset.hrOrg,
                    greeting: cb.dataset.hrGreeting
                });
            });
        } else if (selectedType === 'sent') {
            // Select all sent checkboxes
            document.querySelectorAll('.sent-checkbox').forEach(cb => {
                cb.checked = true;
                const hrId = cb.dataset.hrId;
                selectedHRs.add(hrId);
                selectedHRsData.set(hrId, {
                    id: hrId,
                    full_name: cb.dataset.hrName,
                    office_email: cb.dataset.hrEmail,
                    organization: cb.dataset.hrOrg,
                    greeting: cb.dataset.hrGreeting
                });
            });
        } else if (selectedType === 'completed') {
            // Select all completed checkboxes
            document.querySelectorAll('.completed-checkbox').forEach(cb => {
                cb.checked = true;
                const hrId = cb.dataset.hrId;
                selectedHRs.add(hrId);
                selectedHRsData.set(hrId, {
                    id: hrId,
                    full_name: cb.dataset.hrName,
                    office_email: cb.dataset.hrEmail,
                    organization: cb.dataset.hrOrg,
                    greeting: cb.dataset.hrGreeting
                });
            });
        } else if (selectedType === 'registered') {
            // Select all registered checkboxes
            document.querySelectorAll('.registered-checkbox').forEach(cb => {
                cb.checked = true;
                const hrId = cb.dataset.hrId;
                selectedHRs.add(hrId);
                selectedHRsData.set(hrId, {
                    id: hrId,
                    full_name: cb.dataset.hrName,
                    office_email: cb.dataset.hrEmail,
                    organization: cb.dataset.hrOrg,
                    greeting: cb.dataset.hrGreeting
                });
            });
        } else if (selectedType === 'custom') {
            // For custom selection, don't auto-select anything
            showCustomSelectionModal();
            return;
        }
        
        updateRecipientDisplay();
        updateMobileSelectionUI();
    }

    function updateRecipientDisplay() {
        const displayContainer = document.getElementById('selectedRecipientsDisplay');
        const badgesContainer = document.getElementById('recipientBadges');
        const countText = document.getElementById('selectedCountText');
        const mobileBadgesContainer = document.getElementById('mobileRecipientBadges');
        const mobileCountText = document.getElementById('mobileSelectedCountText');
        const mobileSelectedCount = document.getElementById('mobileSelectedCount');
        const mobileSelectedCountBadge = document.getElementById('mobileSelectedCountBadge');
        const mobileApplyButton = document.getElementById('mobileApplyButton');
        
        if (selectedHRs.size === 0) {
            displayContainer.classList.add('hidden');
            document.getElementById('mobileRecipientsDisplay').classList.add('hidden');
            mobileSelectedCount.classList.add('hidden');
            mobileSelectedCountBadge.classList.add('hidden');
            mobileApplyButton.disabled = true;
            return;
        }
        
        // Update desktop display
        displayContainer.classList.remove('hidden');
        badgesContainer.innerHTML = '';
        
        // Add badges for first 5 recipients
        let count = 0;
        for (const [hrId, hrData] of selectedHRsData.entries()) {
            if (count >= 5) break;
            const badge = document.createElement('span');
            badge.className = 'recipient-badge';
            badge.innerHTML = `
                ${hrData.full_name || hrData.organization}
                <button onclick="removeRecipient('${hrId}')" class="ml-1 text-red-500 hover:text-red-700">
                    <i class="fas fa-times text-xs"></i>
                </button>
            `;
            badgesContainer.appendChild(badge);
            count++;
        }
        
        countText.textContent = `${selectedHRs.size} recipient${selectedHRs.size !== 1 ? 's' : ''} selected`;
        
        // Update mobile display
        const mobileDisplay = document.getElementById('mobileRecipientsDisplay');
        mobileDisplay.classList.remove('hidden');
        mobileBadgesContainer.innerHTML = '';
        
        // Add mobile badges
        let mobileCount = 0;
        for (const [hrId, hrData] of selectedHRsData.entries()) {
            if (mobileCount >= 3) break;
            const badge = document.createElement('span');
            badge.className = 'recipient-badge';
            badge.innerHTML = `
                ${hrData.full_name || hrData.organization}
                <button onclick="removeRecipient('${hrId}')" class="ml-1 text-red-500 hover:text-red-700">
                    <i class="fas fa-times text-xs"></i>
                </button>
            `;
            mobileBadgesContainer.appendChild(badge);
            mobileCount++;
        }
        
        mobileCountText.textContent = `${selectedHRs.size} recipient${selectedHRs.size !== 1 ? 's' : ''} selected`;
        
        // Update mobile buttons
        mobileSelectedCount.textContent = selectedHRs.size;
        mobileSelectedCountBadge.textContent = selectedHRs.size;
        mobileSelectedCount.classList.remove('hidden');
        mobileSelectedCountBadge.classList.remove('hidden');
        mobileApplyButton.disabled = false;
    }

    function removeRecipient(hrId) {
        selectedHRs.delete(hrId);
        selectedHRsData.delete(hrId);
        
        // Uncheck the corresponding checkbox
        const checkbox = document.querySelector(`.hr-checkbox[data-hr-id="${hrId}"]`);
        if (checkbox) {
            checkbox.checked = false;
        }
        
        updateRecipientDisplay();
        updateMobileSelectionUI();
    }

    function clearRecipientSelection() {
        selectedHRs.clear();
        selectedHRsData.clear();
        
        // Uncheck all checkboxes
        document.querySelectorAll('.hr-checkbox').forEach(cb => {
            cb.checked = false;
        });
        
        updateRecipientDisplay();
        updateMobileSelectionUI();
    }

    // ========== SEND BULK EMAIL ==========
    async function sendBulkEmail() {
        if (selectedHRs.size === 0) {
            showNotification('error', 'Please select at least one recipient');
            return;
        }
        
        // Show confirmation dialog
        const confirmed = confirm(`Send ${currentEmailTemplate === 'invitation' ? 'invitations' : 'reminders'} to ${selectedHRs.size} recipient${selectedHRs.size !== 1 ? 's' : ''}?`);
        if (!confirmed) return;
        
        // Show loading modal
        const totalRecipients = selectedHRs.size;
        showLoadingModal(`Sending ${currentEmailTemplate === 'invitation' ? 'invitations' : 'reminders'} to ${totalRecipients} recipients...`);
        updateProgress(0, totalRecipients);
        
        try {
            // Prepare FormData
            const formData = new FormData();
            formData.append('email_type', currentEmailTemplate);
            
            // Add HR IDs
            formData.append('hr_ids', JSON.stringify(Array.from(selectedHRs)));
            
            // Add uploaded files (max 3)
            uploadedFiles.slice(0, 3).forEach((file, index) => {
                formData.append(`attachments`, file);
            });
            
            // Send to server
            const response = await fetch('/admin/send-bulk-email', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            // Hide loading modal
            hideLoadingModal();
            
            if (data.success) {
                // Show success modal
                showSuccessModal(
                    `${currentEmailTemplate === 'invitation' ? 'Invitations' : 'Reminders'} sent successfully!`,
                    `Sent ${data.sent_count || data.sent_count} ${currentEmailTemplate === 'invitation' ? 'invitations' : 'reminders'} to selected recipients.`
                );
                
                // Clear selection and files
                selectedHRs.clear();
                selectedHRsData.clear();
                uploadedFiles = [];
                document.getElementById('filePreview').innerHTML = '';
                updateFileCounter();
                
                updateRecipientDisplay();
                updateMobileSelectionUI();
                
                // Uncheck all checkboxes
                document.querySelectorAll('.hr-checkbox').forEach(cb => {
                    cb.checked = false;
                });
                
                // Refresh page after delay
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            } else {
                showNotification('error', data.error || 'Failed to send emails');
            }
        } catch (error) {
            console.error('Error:', error);
            hideLoadingModal();
            showNotification('error', 'Failed to send emails. Please try again.');
        }
    }

    // ========== TAB AND CHECKBOX FUNCTIONS ==========
    function showTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(el => {
            el.classList.add('hidden');
        });
        
        // Remove active class from all tab buttons
        document.querySelectorAll('.tab-button').forEach(el => {
            el.classList.remove('active');
        });
        
        // Show selected tab content
        const tabContentId = `tabContent${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`;
        const tabContent = document.getElementById(tabContentId);
        if (tabContent) {
            tabContent.classList.remove('hidden');
        }
        
        // Add active class to selected tab button
        const tabButtonId = `tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`;
        const tabButton = document.getElementById(tabButtonId);
        if (tabButton) {
            tabButton.classList.add('active');
        }
        
        // Update mobile UI if needed
        updateMobileSelectionUI();
    }

    function toggleAllNew(checked) {
        document.querySelectorAll('.new-checkbox').forEach(cb => {
            cb.checked = checked;
            if (checked) {
                selectedHRs.add(cb.dataset.hrId);
                selectedHRsData.set(cb.dataset.hrId, {
                    id: cb.dataset.hrId,
                    full_name: cb.dataset.hrName,
                    office_email: cb.dataset.hrEmail,
                    organization: cb.dataset.hrOrg,
                    greeting: cb.dataset.hrGreeting
                });
            } else {
                selectedHRs.delete(cb.dataset.hrId);
                selectedHRsData.delete(cb.dataset.hrId);
            }
        });
        updateRecipientDisplay();
        updateMobileSelectionUI();
    }

    function toggleAllPending(checked) {
        document.querySelectorAll('.pending-checkbox').forEach(cb => {
            cb.checked = checked;
            if (checked) {
                selectedHRs.add(cb.dataset.hrId);
                selectedHRsData.set(cb.dataset.hrId, {
                    id: cb.dataset.hrId,
                    full_name: cb.dataset.hrName,
                    office_email: cb.dataset.hrEmail,
                    organization: cb.dataset.hrOrg,
                    greeting: cb.dataset.hrGreeting
                });
            } else {
                selectedHRs.delete(cb.dataset.hrId);
                selectedHRsData.delete(cb.dataset.hrId);
            }
        });
        updateRecipientDisplay();
        updateMobileSelectionUI();
    }

    function toggleAllSent(checked) {
        document.querySelectorAll('.sent-checkbox').forEach(cb => {
            cb.checked = checked;
            if (checked) {
                selectedHRs.add(cb.dataset.hrId);
                selectedHRsData.set(cb.dataset.hrId, {
                    id: cb.dataset.hrId,
                    full_name: cb.dataset.hrName,
                    office_email: cb.dataset.hrEmail,
                    organization: cb.dataset.hrOrg,
                    greeting: cb.dataset.hrGreeting
                });
            } else {
                selectedHRs.delete(cb.dataset.hrId);
                selectedHRsData.delete(cb.dataset.hrId);
            }
        });
        updateRecipientDisplay();
        updateMobileSelectionUI();
    }

    function toggleAllCompleted(checked) {
        document.querySelectorAll('.completed-checkbox').forEach(cb => {
            cb.checked = checked;
            if (checked) {
                selectedHRs.add(cb.dataset.hrId);
                selectedHRsData.set(cb.dataset.hrId, {
                    id: cb.dataset.hrId,
                    full_name: cb.dataset.hrName,
                    office_email: cb.dataset.hrEmail,
                    organization: cb.dataset.hrOrg,
                    greeting: cb.dataset.hrGreeting
                });
            } else {
                selectedHRs.delete(cb.dataset.hrId);
                selectedHRsData.delete(cb.dataset.hrId);
            }
        });
        updateRecipientDisplay();
        updateMobileSelectionUI();
    }

    function toggleAllRegistered(checked) {
        document.querySelectorAll('.registered-checkbox').forEach(cb => {
            cb.checked = checked;
            if (checked) {
                selectedHRs.add(cb.dataset.hrId);
                selectedHRsData.set(cb.dataset.hrId, {
                    id: cb.dataset.hrId,
                    full_name: cb.dataset.hrName,
                    office_email: cb.dataset.hrEmail,
                    organization: cb.dataset.hrOrg,
                    greeting: cb.dataset.hrGreeting
                });
            } else {
                selectedHRs.delete(cb.dataset.hrId);
                selectedHRsData.delete(cb.dataset.hrId);
            }
        });
        updateRecipientDisplay();
        updateMobileSelectionUI();
    }

    function toggleAll(checked) {
        document.querySelectorAll('.all-checkbox').forEach(cb => {
            cb.checked = checked;
            if (checked) {
                selectedHRs.add(cb.dataset.hrId);
                selectedHRsData.set(cb.dataset.hrId, {
                    id: cb.dataset.hrId,
                    full_name: cb.dataset.hrName,
                    office_email: cb.dataset.hrEmail,
                    organization: cb.dataset.hrOrg,
                    greeting: cb.dataset.hrGreeting
                });
            } else {
                selectedHRs.delete(cb.dataset.hrId);
                selectedHRsData.delete(cb.dataset.hrId);
            }
        });
        updateRecipientDisplay();
        updateMobileSelectionUI();
    }

    function selectAllInTab(tabName) {
        if (tabName === 'new') toggleAllNew(true);
        else if (tabName === 'pending') toggleAllPending(true);
        else if (tabName === 'sent') toggleAllSent(true);
        else if (tabName === 'completed') toggleAllCompleted(true);
        else if (tabName === 'registered') toggleAllRegistered(true);
        else if (tabName === 'all') toggleAll(true);
    }

    // ========== MOBILE FUNCTIONS ==========
    function openMobileRecipientPanel() {
        document.getElementById('mobileRecipientPanel').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeMobileRecipientPanel() {
        document.getElementById('mobileRecipientPanel').classList.remove('active');
        document.body.style.overflow = 'auto';
    }

    function selectMobileRecipientType(type) {
        // Update visual selection
        document.querySelectorAll('.recipient-option').forEach(option => {
            option.classList.remove('active');
            option.querySelector('.w-3').classList.add('hidden');
        });
        
        const selectedOption = document.getElementById(`mobileOption${type.charAt(0).toUpperCase() + type.slice(1)}`);
        selectedOption.classList.add('active');
        selectedOption.querySelector('.w-3').classList.remove('hidden');
        
        selectedRecipientType = type;
        
        // Clear current selection
        selectedHRs.clear();
        selectedHRsData.clear();
        
        // Uncheck all checkboxes
        document.querySelectorAll('.hr-checkbox').forEach(cb => {
            cb.checked = false;
        });
        
        // For custom selection, show the modal
        if (type === 'custom') {
            setTimeout(() => {
                showCustomSelectionModal();
            }, 300);
            return;
        }
        
        // Select appropriate checkboxes
        const checkboxClass = `${type}-checkbox`;
        document.querySelectorAll(`.${checkboxClass}`).forEach(cb => {
            cb.checked = true;
            const hrId = cb.dataset.hrId;
            selectedHRs.add(hrId);
            selectedHRsData.set(hrId, {
                id: hrId,
                full_name: cb.dataset.hrName,
                office_email: cb.dataset.hrEmail,
                organization: cb.dataset.hrOrg,
                greeting: cb.dataset.hrGreeting
            });
        });
        
        updateRecipientDisplay();
        updateMobileSelectionUI();
    }

    function applyMobileSelection() {
        closeMobileRecipientPanel();
        showNotification('success', `Selected ${selectedHRs.size} recipients`);
    }

    function updateMobileSelectionUI() {
        const mobileSelectedCount = document.getElementById('mobileSelectedCount');
        const mobileSelectedCountBadge = document.getElementById('mobileSelectedCountBadge');
        
        if (selectedHRs.size > 0) {
            mobileSelectedCount.textContent = selectedHRs.size;
            mobileSelectedCountBadge.textContent = selectedHRs.size;
            mobileSelectedCount.classList.remove('hidden');
            mobileSelectedCountBadge.classList.remove('hidden');
        } else {
            mobileSelectedCount.classList.add('hidden');
            mobileSelectedCountBadge.classList.add('hidden');
        }
    }

    // ========== CUSTOM SELECTION MODAL ==========
    function showCustomSelectionModal() {
        const modal = document.getElementById('customSelectionModal');
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        
        // Load HR list
        loadCustomSelectionList();
    }

    function hideCustomSelectionModal() {
        const modal = document.getElementById('customSelectionModal');
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    function loadCustomSelectionList() {
        const container = document.getElementById('hrListContainer');
        
        // Get all HR data from the current active tab
        const activeTab = document.querySelector('.tab-button.active');
        let tabName = 'pending';
        if (activeTab) {
            const tabId = activeTab.id;
            if (tabId.includes('New')) tabName = 'new';
            else if (tabId.includes('Pending')) tabName = 'pending';
            else if (tabId.includes('Sent')) tabName = 'sent';
            else if (tabId.includes('Completed')) tabName = 'completed';
            else if (tabId.includes('Registered')) tabName = 'registered';
            else if (tabId.includes('All')) tabName = 'all';
        }
        
        // Get appropriate checkboxes
        const checkboxClass = tabName === 'all' ? 'all-checkbox' : `${tabName}-checkbox`;
        const checkboxes = document.querySelectorAll(`.${checkboxClass}`);
        
        container.innerHTML = '';
        
        checkboxes.forEach(cb => {
            const hrId = cb.dataset.hrId;
            const hrName = cb.dataset.hrName || 'Unknown';
            const hrEmail = cb.dataset.hrEmail || 'No email';
            const hrOrg = cb.dataset.hrOrg || 'Unknown';
            
            const item = document.createElement('div');
            item.className = 'hr-selection-item';
            if (selectedHRs.has(hrId)) {
                item.classList.add('selected');
            }
            
            item.innerHTML = `
                <input type="checkbox" class="checkbox-round custom-hr-checkbox" 
                       data-hr-id="${hrId}"
                       ${selectedHRs.has(hrId) ? 'checked' : ''}
                       onchange="toggleCustomHRSelection('${hrId}', this.checked)">
                <div class="hr-selection-item-content">
                    <div class="hr-selection-item-name">${hrName}</div>
                    <div class="hr-selection-item-details">${hrOrg} • ${hrEmail}</div>
                </div>
            `;
            
            container.appendChild(item);
        });
        
        updateModalSelectedCount();
    }

    function toggleCustomHRSelection(hrId, checked) {
        const checkbox = document.querySelector(`.hr-checkbox[data-hr-id="${hrId}"]`);
        if (checkbox) {
            checkbox.checked = checked;
        }
        
        if (checked) {
            selectedHRs.add(hrId);
            const hrData = {
                id: hrId,
                full_name: checkbox ? checkbox.dataset.hrName : 'Unknown',
                office_email: checkbox ? checkbox.dataset.hrEmail : 'No email',
                organization: checkbox ? checkbox.dataset.hrOrg : 'Unknown',
                greeting: checkbox ? checkbox.dataset.hrGreeting : 'HR Professional'
            };
            selectedHRsData.set(hrId, hrData);
        } else {
            selectedHRs.delete(hrId);
            selectedHRsData.delete(hrId);
        }
        
        // Update UI
        const item = document.querySelector(`.hr-selection-item input[data-hr-id="${hrId}"]`).closest('.hr-selection-item');
        if (item) {
            if (checked) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        }
        
        updateModalSelectedCount();
        updateRecipientDisplay();
        updateMobileSelectionUI();
    }

    function updateModalSelectedCount() {
        const countElement = document.getElementById('modalSelectedCount');
        countElement.textContent = `${selectedHRs.size} selected`;
    }

    function applyCustomSelection() {
        hideCustomSelectionModal();
        selectedRecipientType = 'custom';
        
        // Update radio button
        const customRadio = document.querySelector('input[name="recipientType"][value="custom"]');
        if (customRadio) {
            customRadio.checked = true;
        }
        
        // Update recipient display
        updateRecipientDisplay();
        updateMobileSelectionUI();
        
        showNotification('success', `Custom selection applied: ${selectedHRs.size} recipients`);
    }

    function filterHRList() {
        const searchTerm = document.getElementById('hrSearch').value.toLowerCase();
        const filterType = document.getElementById('hrFilter').value;
        
        const items = document.querySelectorAll('.hr-selection-item');
        
        items.forEach(item => {
            const name = item.querySelector('.hr-selection-item-name').textContent.toLowerCase();
            const details = item.querySelector('.hr-selection-item-details').textContent.toLowerCase();
            
            // Check search term
            const matchesSearch = searchTerm === '' || name.includes(searchTerm) || details.includes(searchTerm);
            
            // Check filter type (you would need to add data attributes for filter)
            const matchesFilter = filterType === 'all' || true; // Simplified for now
            
            if (matchesSearch && matchesFilter) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    // ========== MODAL FUNCTIONS ==========
    function showLoadingModal(message) {
        document.getElementById('loadingMessage').textContent = message;
        document.getElementById('loadingModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function hideLoadingModal() {
        document.getElementById('loadingModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    function showSuccessModal(message, details) {
        document.getElementById('successMessage').textContent = message;
        document.getElementById('successDetails').textContent = details;
        document.getElementById('successModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function hideSuccessModal() {
        document.getElementById('successModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    function updateProgress(current, total) {
        document.getElementById('progressText').textContent = `${current}/${total} sent`;
    }

    // ========== NOTIFICATION FUNCTION ==========
    function showNotification(type, message) {
        // Remove any existing notifications
        const existingNotifications = document.querySelectorAll('.notification');
        existingNotifications.forEach(notification => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        });
        
        const notification = document.createElement('div');
        notification.className = `notification fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' : 
            type === 'error' ? 'bg-red-500 text-white' : 
            'bg-blue-500 text-white'
        }`;
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} mr-2"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }

    // ========== MOBILE SIDEBAR FUNCTIONS ==========
    function openMobileSidebar() {
        document.getElementById('mobileSidebarOverlay').classList.add('active');
        document.getElementById('mobileSidebarPanel').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeMobileSidebar() {
        document.getElementById('mobileSidebarOverlay').classList.remove('active');
        document.getElementById('mobileSidebarPanel').classList.remove('active');
        document.body.style.overflow = 'auto';
    }

    // ========== INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize mobile menu button
        document.getElementById('mobileMenuButton').addEventListener('click', openMobileSidebar);
        
        // Initialize mobile sidebar overlay
        document.getElementById('mobileSidebarOverlay').addEventListener('click', closeMobileSidebar);
        
        // Initialize checkbox listeners
        document.querySelectorAll('.hr-checkbox').forEach(cb => {
            cb.addEventListener('change', function() {
                const hrId = this.dataset.hrId;
                const hrName = this.dataset.hrName;
                const hrEmail = this.dataset.hrEmail;
                const hrOrg = this.dataset.hrOrg;
                const hrGreeting = this.dataset.hrGreeting;
                
                if (this.checked) {
                    selectedHRs.add(hrId);
                    selectedHRsData.set(hrId, {
                        id: hrId,
                        full_name: hrName,
                        office_email: hrEmail,
                        organization: hrOrg,
                        greeting: hrGreeting
                    });
                } else {
                    selectedHRs.delete(hrId);
                    selectedHRsData.delete(hrId);
                }
                updateRecipientDisplay();
                updateMobileSelectionUI();
            });
        });
        
        // Set default template
        selectEmailTemplate('invitation');
        
        // Set default recipient type
        document.querySelector('input[name="recipientType"][value="pending"]').checked = true;
        
        // Initialize with new tab active
        showTab('new');
    });

    // ========== HELPER FUNCTIONS FOR ACTION BUTTONS ==========
    function sendSingleInvitation(hrId, hrName) {
        if (confirm(`Send invitation to ${hrName}?`)) {
            showLoadingModal(`Sending invitation to ${hrName}...`);
            
            fetch(`/admin/send-invitation/${hrId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoadingModal();
                if (data.success) {
                    showNotification('success', data.message);
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showNotification('error', data.error || 'Failed to send invitation');
                }
            })
            .catch(error => {
                hideLoadingModal();
                showNotification('error', 'Failed to send invitation');
                console.error('Error:', error);
            });
        }
    }

    function sendAllNew() {
        if (confirm('Send invitations to all new HR professionals?')) {
            showLoadingModal('Sending invitations to all new HR professionals...');
            
            fetch('/admin/send-all-invitations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoadingModal();
                if (data.success) {
                    showNotification('success', data.message);
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showNotification('error', data.error || 'Failed to send invitations');
                }
            })
            .catch(error => {
                hideLoadingModal();
                showNotification('error', 'Failed to send invitations');
                console.error('Error:', error);
            });
        }
    }

    function sendAllPending() {
        if (confirm('Send invitations to all pending HR professionals?')) {
            // Select all pending
            selectAllInTab('pending');
            // Send bulk email
            sendBulkEmail();
        }
    }

    function resendAllSent() {
        if (confirm('Resend invitations to all sent HR professionals?')) {
            // Select all sent
            selectAllInTab('sent');
            // Change to reminder template and send
            selectEmailTemplate('reminder');
            sendBulkEmail();
        }
    }

    function viewHRDetails(hrId) {
        alert(`View details for HR ID: ${hrId}\n\nThis would open a detailed view in a future update.`);
    }

    function copyInvitationLink(url) {
        if (!url) {
            showNotification('error', 'No invitation link available');
            return;
        }
        
        navigator.clipboard.writeText(url)
            .then(() => {
                showNotification('success', 'Invitation link copied to clipboard!');
            })
            .catch(err => {
                console.error('Failed to copy: ', err);
                showNotification('error', 'Failed to copy link');
            });
    }
</script>
</body>
</html>